var modelClass  = require('./model.js'),
    appData     = require('./config.js');
    
// # Admin Controller
var adminController = {
    'pageIndex': function(req, res) {
        var msg = {};
        
        if(req.session.reset) {
            msg.reset = req.session.reset;
            req.session.reset = null;
        }
        
        if(req.session.error) {
            msg.err = req.session.error;
            req.session.error = null;
        }
        
        
        if(req.session.notfound) {
            msg.notfound = req.session.notfound;
            req.session.notfound = null;
        }
        
        pageModel = new modelClass();
        var pageData = pageModel.getPageList(function(err, pageData) {
            if(err) {
                req.session.error = 'An error occured!';
                console.log("SQLite Error");
                res.redirect(appData.url + '/');
            }
            
            res.render(appData.viewDir + '/index', { msg: msg, pageData: pageData, appData: appData});
        });
    },
    
    'pageSingle': function(req, res) {
        var pageID = req.query.id;
        if(!pageID) {
            req.session.notfound = "Requested page not in database";
            res.redirect(appData.url + '/');
        }
        
        pageModel = new modelClass();
        var pageData = pageModel.getPage(pageID, function (err, pageData) {
            if(!err && !pageData) {
                req.session.notfound = "Requested page not in database";
                res.redirect(appData.url + '/');
            } else if(err) {
                req.session.error = 'An error occured!';
                console.log("SQLite Error");
                res.redirect(appData.url + '/');
            } 
            
            res.render(appData.viewDir + '/page', { pageData: pageData, appData: appData });
        });
        
        
    },
    
    'brief': function(req, res) {
        res.render(appData.viewDir + '/brief', { appData: appData });
    },
    
    'reset' : function(req, res, next) {
        pageModel = new modelClass();
        pageModel.resetChallenge();
        
        req.session.reset = "Page SQL Exploit Challenge Reset";
        res.redirect(appData.url + '/');
    }
};

module.exports = adminController;