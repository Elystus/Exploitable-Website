var path    = require("path"),
    sqlite  = require("sqlite3").verbose(),
    crypto  = require("crypto"),
    config  = require("./config.js"),
    appConfig = require("../../config");
    
var dbBuilder = require("./database/" + config.database + ".db.js");

var AccountClass = function () {
    _table = "users";
    
    dbObj = function () {
        var db = new sqlite.Database(path.join(appConfig.paths.core, config.baseDir, "database", ("/" +  config.database + ".db")));
        
        return db;
    };
    
    getTable = function () {
        return _table;
    };
    
    /*
     * Create password hash using sha256 encryption
     * @param @String() password
     * @param @String() salt
     * @returns @String() Hashed password
     */
    hashPassword = function (password, salt) {
        var hash = crypto.createHash('sha256');
        hash.update(password);
        hash.update(salt);
        return hash.digest('hex');
    };
    
    /*
     * Generates salt for new account
     * @returns salt
     */
    generateSalt = function () {
        return crypto.randomBytes(256);
    };
    
    
    rebuildDatabase = function() {
        dbBuilder();
    };
    
};

AccountClass.prototype = {
    // Class constructor (Allows for OOP)
    constructor: AccountClass,
    
    /*
     * Verify login credentials
     *  - Will return fn(err) if login fails
     * @param String username
     * @param String password
     * @param String fn
     * @returns Boolean
     */
    authRequest: function (username, password, fn) {
        var db = dbObj(),
            hashPass = hashPassword;
    
        db.get("SELECT salt FROM " + getTable() + " WHERE username = '" + username + "'", function(err, row) {
            if(err)
                return fn(err);
            
            console.log('test time');
            if(!row)
                return fn(null, null);
            
            console.log('test');
            

            var hash = hashPassword(password, row.salt);
            db.get("SELECT username, id FROM " + getTable() + " WHERE username = '" + username + "' AND password = '" + hash + "'", function(err, row) {
                if (err) 
                    throw fn(err);

                if(row) {
                    console.log("auth correct");
                    return fn(null, row);
                }

                return fn(null, null);
            });
        });
    },
    
    authError: function(err) {
        console.log(err);
        return true;
    },
    
    resetChallenge: function() {
        dbBuilder();
    }
    
};
module.exports = AccountClass;