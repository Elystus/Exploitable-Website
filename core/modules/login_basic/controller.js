var modelClass  = require('./model.js'),
    appData     = require('./config.js');
    
// # Admin Controller
var adminController = {
    'login': function(req, res) {
        if(req.session.user)
            res.redirect(appData.url + '/success');
        
        var msg = {};
        if(req.session.error) {
            msg.err = req.session.error;
            req.session.error = null;
        }
        
        res.render(appData.viewDir + '/login', { msg: msg, appData: appData});
    },
    
    'brief': function(req, res) {
        res.render(appData.viewDir + '/brief', { appData: appData });
    },
    
    'loginPost': function(req, res) {
        var auth = new modelClass();
        
        if(req.session.user)
            res.redirect(appData.url + '/success');
        
        else {
            try{ 
                auth.authRequest(req.body["auth-login-user"], req.body["auth-login-pass"], function(err, user) {
                    if(user) {
                        req.session.regenerate(function() {
                            req.session.user = user;
                            req.session.success = 'Authenticated as ' + user.name;
                            req.session.save();
                            res.redirect(appData.url + '/success');
                        });
                    } else if(err) {
                        req.session.error = 'An error occured upon login! Sorry for the inconvenience.';
                        console.log("SQLite Error");
                        res.redirect(appData.url + '/login');
                    } else if (user == null && err == null ){
                        req.session.error = 'Invalid Username and Password combination';
                        console.log("Invalid Login");
                        res.redirect(appData.url + '/login');
                    }
                });
            } catch (e) {
                console.log(e);
            }
        }
    },
    
    'logout': function(req, res) {
        req.session.destroy();
        res.redirect(appData.url + '/login');
    },
    
    'authCheck': function(req, res, next) {
        if(req.session.user)
            return next();
        
        req.session.denied = "You need to be logged in to view this page";
        res.redirect(appData.url + '/login');
    },
    
    'success' : function(req, res, next) {
        if(!req.session.user)
            res.redirect(appData.url + '/login');
        
        res.render(appData.viewDir + '/success', { appData: appData, isAuth: true });
    },
    
    'reset' : function(req, res, next) {
        auth = new modelClass();
        auth.resetChallenge();
        
        req.session.error = "Challenge Reset";
        if(req.session.user)
            res.redirect(appData.url + '/logout');
        else
            res.redirect(appData.url + '/login');
    }
};

module.exports = adminController;